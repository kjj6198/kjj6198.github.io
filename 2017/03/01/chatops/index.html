<!DOCTYPE html>
<html>
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    
    <title>Rails app è‡ªå‹•åŒ–éƒ¨å±¬ - hubot èˆ‡ heaven | å‰ç«¯æ›¬è¡£å ´</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="devops,chatops,capistrano" />
    
    <meta name="description" content="å‰è¨€ç›®å‰æ‰€åœ¨çš„å…¬å¸è£¡é ­æ˜¯ç›´æ¥åœ¨æœ¬åœ°ç«¯çš„ terminal è·‘ cap staging deploy æŒ‡ä»¤ã€‚ capistrano ä½œç‚ºè‡ªå‹•éƒ¨ç½²åŒ–çš„å·¥å…·éå¸¸æ–¹ä¾¿ï¼Œä½†é›£å…æœƒé‡åˆ°å¹¾å€‹å•é¡Œï¼š

ä¸æ˜¯åœ˜éšŠä¸­çš„æ¯å€‹äººéƒ½æœ‰ç›¸åŒçš„ç’°å¢ƒ
å¤§å®¶éƒ½åœ¨éƒ¨ç½²ï¼Œçµæœ staging ä¸Šç¾åœ¨åˆ°åº•æ˜¯å“ªå€‹ branchï¼Œå®Œå…¨ä¸€é ­éœ§æ°´ã€‚
deploy é€™ä»¶äº‹æƒ…å¡åœ¨æœ¬åœ°ç«¯ã€‚

å°ä¸€å®¶æ–°å‰µä¾†èªªï¼Œè¶Šç©©å®šçš„é–‹ç™¼æ•ˆç‡å’Œæµç¨‹ï¼Œå°±è¶Šèƒ½å¤ å°ˆæ³¨åœ¨ç”¢å“">
<meta property="og:type" content="article">
<meta property="og:title" content="Rails app è‡ªå‹•åŒ–éƒ¨å±¬ - hubot èˆ‡ heaven">
<meta property="og:url" content="http://kjj6198.github.io/blog/2017/03/01/chatops/index.html">
<meta property="og:site_name" content="å‰ç«¯æ›¬è¡£å ´">
<meta property="og:description" content="å‰è¨€ç›®å‰æ‰€åœ¨çš„å…¬å¸è£¡é ­æ˜¯ç›´æ¥åœ¨æœ¬åœ°ç«¯çš„ terminal è·‘ cap staging deploy æŒ‡ä»¤ã€‚ capistrano ä½œç‚ºè‡ªå‹•éƒ¨ç½²åŒ–çš„å·¥å…·éå¸¸æ–¹ä¾¿ï¼Œä½†é›£å…æœƒé‡åˆ°å¹¾å€‹å•é¡Œï¼š

ä¸æ˜¯åœ˜éšŠä¸­çš„æ¯å€‹äººéƒ½æœ‰ç›¸åŒçš„ç’°å¢ƒ
å¤§å®¶éƒ½åœ¨éƒ¨ç½²ï¼Œçµæœ staging ä¸Šç¾åœ¨åˆ°åº•æ˜¯å“ªå€‹ branchï¼Œå®Œå…¨ä¸€é ­éœ§æ°´ã€‚
deploy é€™ä»¶äº‹æƒ…å¡åœ¨æœ¬åœ°ç«¯ã€‚

å°ä¸€å®¶æ–°å‰µä¾†èªªï¼Œè¶Šç©©å®šçš„é–‹ç™¼æ•ˆç‡å’Œæµç¨‹ï¼Œå°±è¶Šèƒ½å¤ å°ˆæ³¨åœ¨ç”¢å“">
<meta property="og:image" content="http://kjj6198.github.io/blog/blog/2017/03/01/chatops/process.png">
<meta property="og:updated_time" content="2017-03-02T12:55:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rails app è‡ªå‹•åŒ–éƒ¨å±¬ - hubot èˆ‡ heaven">
<meta name="twitter:description" content="å‰è¨€ç›®å‰æ‰€åœ¨çš„å…¬å¸è£¡é ­æ˜¯ç›´æ¥åœ¨æœ¬åœ°ç«¯çš„ terminal è·‘ cap staging deploy æŒ‡ä»¤ã€‚ capistrano ä½œç‚ºè‡ªå‹•éƒ¨ç½²åŒ–çš„å·¥å…·éå¸¸æ–¹ä¾¿ï¼Œä½†é›£å…æœƒé‡åˆ°å¹¾å€‹å•é¡Œï¼š

ä¸æ˜¯åœ˜éšŠä¸­çš„æ¯å€‹äººéƒ½æœ‰ç›¸åŒçš„ç’°å¢ƒ
å¤§å®¶éƒ½åœ¨éƒ¨ç½²ï¼Œçµæœ staging ä¸Šç¾åœ¨åˆ°åº•æ˜¯å“ªå€‹ branchï¼Œå®Œå…¨ä¸€é ­éœ§æ°´ã€‚
deploy é€™ä»¶äº‹æƒ…å¡åœ¨æœ¬åœ°ç«¯ã€‚

å°ä¸€å®¶æ–°å‰µä¾†èªªï¼Œè¶Šç©©å®šçš„é–‹ç™¼æ•ˆç‡å’Œæµç¨‹ï¼Œå°±è¶Šèƒ½å¤ å°ˆæ³¨åœ¨ç”¢å“">
<meta name="twitter:image" content="http://kjj6198.github.io/blog/blog/2017/03/01/chatops/process.png">
    

    

    

    <link rel="stylesheet" href="/blog/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/blog/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/blog/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/blog/css/style.css">

    <script src="/blog/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/blog/libs/lightgallery/css/lightgallery.min.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-56408806-4', 'auto');
ga('send', 'pageview');

</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    
    

</head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                      å‰ç«¯æ›¬è¡£å ´
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">ä¸€ä½åœ¨å°åŒ—æ±‚ç”Ÿå­˜çš„å¤§å­¸ç”Ÿã€‚å–œæ­¡çœ‹æ—¥åŠ‡ã€å–â˜•ï¸ã€åƒğŸ–ã€‚</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/blog/">ä¸»é </a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="https://kjj6198.github.io/resume/normal/">é—œæ–¼</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="æœå°‹" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="æƒ³è¦æ‰¾..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            PAGES: 'é é¢',
            CATEGORIES: 'åˆ†é¡',
            TAGS: 'æ¨™ç±¤',
            UNTITLED: '(æœªå‘½å)',
        },
        ROOT_URL: '/blog/',
        CONTENT_URL: '/blog/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/blog/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/blog/categories/rails/">rails</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-chatops" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Rails app è‡ªå‹•åŒ–éƒ¨å±¬ - hubot èˆ‡ heaven
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                <a href="/blog/2017/03/01/chatops/" class="article-date">
    <time datetime="2017-03-01T15:12:42.000Z" itemprop="datePublished">2017-03-01</time>
</a>
                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/capistrano/">capistrano</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/chatops/">chatops</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/devops/">devops</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ç›®å‰æ‰€åœ¨çš„å…¬å¸è£¡é ­æ˜¯ç›´æ¥åœ¨æœ¬åœ°ç«¯çš„ terminal è·‘ <code>cap staging deploy</code> æŒ‡ä»¤ã€‚ <a href="https://github.com/capistrano/capistrano" target="_blank" rel="external">capistrano</a> ä½œç‚ºè‡ªå‹•éƒ¨ç½²åŒ–çš„å·¥å…·éå¸¸æ–¹ä¾¿ï¼Œä½†é›£å…æœƒé‡åˆ°å¹¾å€‹å•é¡Œï¼š</p>
<ul>
<li>ä¸æ˜¯åœ˜éšŠä¸­çš„æ¯å€‹äººéƒ½æœ‰ç›¸åŒçš„ç’°å¢ƒ</li>
<li>å¤§å®¶éƒ½åœ¨éƒ¨ç½²ï¼Œçµæœ staging ä¸Šç¾åœ¨åˆ°åº•æ˜¯å“ªå€‹ branchï¼Œå®Œå…¨ä¸€é ­éœ§æ°´ã€‚</li>
<li>deploy é€™ä»¶äº‹æƒ…å¡åœ¨æœ¬åœ°ç«¯ã€‚</li>
</ul>
<p>å°ä¸€å®¶æ–°å‰µä¾†èªªï¼Œè¶Šç©©å®šçš„é–‹ç™¼æ•ˆç‡å’Œæµç¨‹ï¼Œå°±è¶Šèƒ½å¤ å°ˆæ³¨åœ¨ç”¢å“ç•¶ä¸­ã€‚æ‰€ä»¥æˆ‘å€‘å¸Œæœ›åšåˆ°å¹¾ä»¶äº‹ï¼š</p>
<ul>
<li>é–‹ç™¼åœ˜éšŠéƒ½å¯ä»¥è¼•é¬†çš„éƒ¨ç½²</li>
<li>ä¸ç”¨åœ¨æœ¬åœ°ç«¯ä¸‹æŒ‡ä»¤éƒ¨ç½²ï¼Œé‚„è¦å¤šè¨­å®š sshã€‚</li>
<li>å°±ç®—æ²’æœ‰é–‹è‘—é›»è…¦ï¼Œä¹Ÿå¯ä»¥è¼•é¬†åœ°éƒ¨ç½²</li>
<li>èƒ½å¤ è¨˜éŒ„éƒ¨ç½²çš„ç‹€æ³</li>
<li>å¦‚æœå‡ºå•é¡Œäº†ï¼Œå¯ä»¥å¿«é€Ÿ rollback å›ä¸Šä¸€å€‹ç‰ˆæœ¬</li>
</ul>
<p>é€æ¼¸å­å€¦äº†åœ¨ terminal æ‰“æŒ‡ä»¤ï¼Œssh key æ‰‹å‹•åŠ çš„æ—¥å­ã€‚æ–¼æ˜¯æ‰“ç®—è‡ªå·±ç ”ç©¶æœ‰æ²’æœ‰æ›´æµæš¢çš„éƒ¨ç½²æµç¨‹ã€‚</p>
<p>ä¹‹å‰åœ¨ Sudo è£¡é ­ï¼Œå¹¸å¥½æœ‰ <a href="https://twitter.com/ocowchun" target="_blank" rel="external">@ocowchun</a> è·Ÿ <a href="https://twitter.com/henry40408" target="_blank" rel="external">@henry</a> å…©ä½æ‡¶å·¥ï¼Œdevops åšå¾—éå¸¸å®Œæ•´ï¼Œæ‰èƒ½å¤ å°ˆæ³¨åœ¨é–‹ç™¼åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ä¸€å †ç¹è¤‡çš„è¨­å®šç•¶ä¸­ã€‚ï¼ˆé›–ç„¶æ‰å‰›é–‹ç™¼å®Œå°±é—œé–‰æœå‹™äº†â€¦ï¼‰</p>
<p>ç›®å‰è¦ºå¾—æœ€åˆé©çš„è§£æ±ºæ–¹æ¡ˆæ˜¯æ­é… <code>hubot-deploy</code> ä»¥åŠ <code>heaven</code> ä¾†å¹«åŠ©éƒ¨ç½²ã€‚</p>
<p>ä½† heaven çš„æ–‡ä»¶å¯¦åœ¨å¯«çš„æœ‰å¤ çˆ›ã€‚</p>
<p>çœ‹äº†è€åŠå¤©ï¼Œç”šè‡³çœ‹äº†ä¸€ä¸‹ source code æ‰çŸ¥é“åˆ°åº•è©²æ€éº¼è¨­å®šã€‚æ–¼æ˜¯æ±ºå®šå°‡æ•´å€‹è¨­å®šæµç¨‹åˆ†äº«çµ¦å¤§å®¶ï¼Œå¸Œæœ›èƒ½å¤ æ¸›å°‘å…¶ä»– devops å€‘èµ°æ­ªè·¯çš„æ™‚é–“ã€‚</p>
<h2 id="ä¸»è¦æµç¨‹"><a href="#ä¸»è¦æµç¨‹" class="headerlink" title="ä¸»è¦æµç¨‹"></a>ä¸»è¦æµç¨‹</h2><img src="/blog/2017/03/01/chatops/process.png" alt="Github deployment process" title="Github deployment process">
<p>hubot æ¥æ”¶åˆ°éƒ¨ç½²æŒ‡ä»¤å¾Œï¼Œæœƒç™¼é€ <a href="https://developer.github.com/v3/repos/deployments" target="_blank" rel="external">github deployment</a>ï¼ŒåŒæ™‚æœƒè§¸ç™¼ <code>deployment</code> é€™å€‹äº‹ä»¶ï¼Œé€™æ™‚ github å°±æœƒç™¼é€ POST çµ¦åœ¨ webhook è¨­ç½®çš„ urlï¼ˆé€™é‚Šæ¥æ”¶è€…ç‚º <code>heaven</code>ï¼‰ï¼Œheaven æ¥æ”¶åˆ°è«‹æ±‚ä¹‹å¾Œï¼Œå°±æœƒé–‹å§‹éƒ¨ç½²ï¼Œå†ä¸€ä¸€å›å‚³æˆ‘å€‘æƒ³è¦çŸ¥é“çš„éƒ¨æ•¸ç‹€æ³ã€‚</p>
<h3 id="hubot-deploy"><a href="#hubot-deploy" class="headerlink" title="hubot-deploy"></a>hubot-deploy</h3><p>hubot-deploy èƒ½å¤ ç”¨ slack å° slack-bot ä¸‹æŒ‡ä»¤çš„æ–¹å¼å»ºç«‹ github çš„ <a href="https://developer.github.com/v3/repos/deployments" target="_blank" rel="external">deployment</a> eventã€‚</p>
<h3 id="heaven"><a href="#heaven" class="headerlink" title="heaven"></a>heaven</h3><p>æ˜¯ä¸€å€‹ Rails çš„ applicationã€‚ä¸»è¦æœ‰ä¸€å€‹ <code>/events</code> è² è²¬æ¥æ”¶å¾ github deployment å‚³ä¾†çš„ deployment èˆ‡ payloadã€‚</p>
<h2 id="è¨­å®šæ­¥é©Ÿ"><a href="#è¨­å®šæ­¥é©Ÿ" class="headerlink" title="è¨­å®šæ­¥é©Ÿ"></a>è¨­å®šæ­¥é©Ÿ</h2><p><code>heaven</code> çš„æ–‡ä»¶å¯«å¾—ä¸æ˜æ‰€ä»¥<code>hubot-deploy</code> ä¹Ÿæ˜¯è‰è‰å¸¶éã€‚å¹¾ä¹åªèƒ½é è‘—ä»–å€‘æä¾›çš„æµç¨‹åœ–ï¼Œä¸æ–·çš„è©¦éŒ¯èˆ‡é€šéˆã€‚</p>
<h3 id="è¨­å®š-hubot-deploy"><a href="#è¨­å®š-hubot-deploy" class="headerlink" title="è¨­å®š hubot-deploy"></a>è¨­å®š hubot-deploy</h3><ul>
<li><a href="https://hubot.github.com/docs/" target="_blank" rel="external">getting started with hubot</a></li>
</ul>
<ol>
<li><p>åˆ©ç”¨ yeoman ç”¢ç”Ÿ hubotï¼Œä¸¦ä¸”é¸æ“‡ <code>adapter</code> ç‚º <code>slack</code>ã€‚</p>
</li>
<li><p>åœ¨ <code>package.json</code> ä¸­åŠ å…¥ <code>hubot-deploy</code>ï¼Œæˆ–è€… run <code>npm install hubot-deploy --save-dev</code></p>
</li>
<li><p>åœ¨ <code>external-scripts.json</code> è£¡é ­åŠ å…¥ <code>hubot-deploy</code>ã€‚</p>
</li>
<li><p>åˆ°  <code>apps.json</code> ä¸­è¨­å®šæƒ³è¦éƒ¨ç½²çš„ repos æœ‰å“ªäº›ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;repo_name&quot;: &#123;</div><div class="line">    &quot;provider&quot;: &quot;capistrano&quot;,</div><div class="line">    &quot;auto_merge&quot;: false,</div><div class="line">    &quot;repository&quot;: &quot;kjj6198/deploy101&quot;,</div><div class="line">    &quot;environments&quot;: [&quot;production&quot;, &quot;staging&quot;]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€™äº›è³‡æ–™åœ¨ hubot é€å‡º deployment æ™‚æœƒä¸€ä½µå¡å…¥ payload ç•¶ä¸­ã€‚åƒæ˜¯é€™æ¨£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">payload: &#123;</div><div class="line">  &quot;name&quot;: &quot;repo_name&quot;,</div><div class="line">  &quot;robotName&quot;: &quot;yourrobot&quot;,</div><div class="line">  &quot;hosts&quot;: &quot;&quot;,</div><div class="line">  &quot;notify&quot;: &#123;</div><div class="line">    &quot;adapter&quot;: &quot;slack&quot;,</div><div class="line">    &quot;room&quot;: &quot;123456789&quot;,</div><div class="line">    &quot;user&quot;: &quot;123456789&quot;,</div><div class="line">    &quot;user_name&quot;: &quot;kjj6198&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;config&quot;: &#123;</div><div class="line">    &quot;provider&quot;: &quot;capistrano&quot;,</div><div class="line">    &quot;auto_merge&quot;: false,</div><div class="line">    &quot;repository&quot;: &quot;kjj6198/deploy101&quot;,</div><div class="line">    &quot;environments&quot;: [</div><div class="line">      &quot;production&quot;,</div><div class="line">      &quot;staging&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>ç‰¹åˆ¥è¦æ³¨æ„çš„æ˜¯ï¼Œprovider çš„æ¬„ä½ä¹‹å¾Œæœƒé€çµ¦ heavenï¼Œæ‰€ä»¥ provider çš„å€¼å¿…é ˆæ˜¯ heaven æœ‰çš„ï¼ˆä¹‹å¾Œæœƒæåˆ°ï¼‰ï¼Œæˆ–æ˜¯è‡ªå·±å¯¦ä½œ Providerã€‚</p>
<p>é€™æ¨£å­æˆ‘å€‘çš„ hubot å°±ç®—è¨­å®šå®Œæˆäº†ã€‚å…ˆéƒ¨ç½²åˆ° heroku ä¸Šæ¸¬è©¦çœ‹çœ‹ï¼Œéƒ¨ç½²åˆ° heroku å¾ˆç°¡å–®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">heroku login</div><div class="line">git init</div><div class="line">git add .</div><div class="line">git commit &quot;init&quot;</div><div class="line">heroku create</div><div class="line">git push heroku master</div></pre></td></tr></table></figure>
<p>éƒ¨ç½²æˆåŠŸå¾Œï¼Œæ¯”è¼ƒé‡è¦çš„è®Šæ•¸æœ‰å¹¾å€‹ï¼š</p>
<table>
<thead>
<tr>
<th>è®Šæ•¸åç¨±</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td>HUBOT_GITHUB_TOKEN</td>
<td>GITHUB_TOKENï¼Œåˆ°<strong>å€‹äººå¸³è™Ÿ</strong> &gt; settings &gt; personal access tokens è¨­å®šã€‚è¨­å®šå¥½æ¬Šé™ï¼Œå› ç‚º hubot åªæ˜¯ç”¨ä¾†å»ºç«‹ repo çš„ deploymentï¼Œå‹¾é¸ repo å³å¯ã€‚</td>
</tr>
<tr>
<td>HUBOT_SLACK_TOKEN</td>
<td>ä½ çš„ slack-bot tokenã€‚å¯ä»¥åˆ°<a href="https://slack.com/apps/A0F7XDU93-hubot" target="_blank" rel="external">é€™è£¡</a>è¨­å®š</td>
</tr>
</tbody>
</table>
<p>å…¨åŸŸè®Šæ•¸å¯ä»¥åˆ° heroku çš„ dashboard æˆ–æ˜¯ç›´æ¥ç”¨ command line è¨­å®šï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">heroku config:set HUBOT_GITHUB_TOKEN=abcccc</div><div class="line">heroku config:set HUBOT_SLACK_TOKEN=abcccc</div></pre></td></tr></table></figure>
<p>æ¸¬è©¦ä¸€ä¸‹æ˜¯å¦æˆåŠŸã€‚åœ¨ä½ è¨­å®šçš„é »é“ä¸­è¼¸å…¥ <code>hubot deploy:version</code></p>
<img src="/blog/2017/03/01/chatops/success.png" alt="success" title="success">
<p>å…¶ä¸­çš„ <code>hubot</code> è¦è·Ÿä½ çš„æ©Ÿå™¨äººåç¨±ç›¸åŒï¼Œä¾‹å¦‚æ©Ÿå™¨äººçš„åç¨±ç‚º tripmomoï¼Œé‚£éº¼æˆ‘å°±è¦è¼¸å…¥ <code>tripmomo deploy:version</code>ã€‚</p>
<p>æˆåŠŸçš„è©± hubot æœƒå›æ‡‰ä½ ç›®å‰çš„ç‰ˆæœ¬è¨Šæ¯ã€‚</p>
<ol>
<li><p>ç¢ºèª hubot æœ‰é€å‡º deployment äº‹ä»¶ã€‚è¼¸å…¥ <code>hubot deploy app to statging</code></p>
</li>
<li><p>è¼¸å…¥  <code>curl -H &quot;Authorization: token YOUR_GITHUB_TOKEN&quot; https://api.github.com/repos/my-github/my-repo/deployments</code> çœ‹çœ‹ deployment æ˜¯å¦å»ºç«‹æˆåŠŸã€‚å¦‚æœæˆåŠŸæœƒå›å‚³ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"url"</span>: <span class="string">"https://api.github.com/repos/my-github/my-repo/deployments/28301325"</span>,</div><div class="line">    <span class="string">"id"</span>: <span class="number">123456</span>,</div><div class="line">    <span class="string">"sha"</span>: <span class="string">"2e3xxxxxxxaaaaaaabbbbbbb"</span>,</div><div class="line">    <span class="string">"ref"</span>: <span class="string">"develop"</span>,</div><div class="line">    <span class="string">"task"</span>: <span class="string">"deploy"</span>,</div><div class="line">    <span class="string">"payload"</span>: &#123; <span class="comment">// from apps.json</span></div><div class="line">      <span class="string">"name"</span>: <span class="string">"my-app"</span>,</div><div class="line">      <span class="string">"robotName"</span>: <span class="string">"tripmomo"</span>,</div><div class="line">      <span class="string">"hosts"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"notify"</span>: &#123;</div><div class="line">        <span class="string">"adapter"</span>: <span class="string">"slack"</span>,</div><div class="line">        <span class="string">"room"</span>: <span class="string">"aabbccdd"</span>,</div><div class="line">        <span class="string">"user"</span>: <span class="string">"aabbccdd"</span>,</div><div class="line">        <span class="string">"user_name"</span>: <span class="string">"kalan.chen"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="string">"config"</span>: &#123; </div><div class="line">        <span class="string">"provider"</span>: <span class="string">"capistrano"</span>,</div><div class="line">        <span class="string">"auto_merge"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="string">"repository"</span>: <span class="string">"my-github/my-repo"</span>,</div><div class="line">        <span class="string">"environments"</span>: [</div><div class="line">          <span class="string">"production"</span>,</div><div class="line">          <span class="string">"staging"</span></div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"environment"</span>: <span class="string">"staging"</span>,</div><div class="line">    <span class="string">"description"</span>: <span class="string">"deploy on staging from hubot-deploy-v0.13.27"</span>,</div><div class="line">    <span class="string">"creator"</span>: &#123;</div><div class="line">      <span class="string">"login"</span>: <span class="string">"kjj6198"</span>,</div><div class="line">      <span class="string">"id"</span>: <span class="number">123456</span>,</div><div class="line">      <span class="string">"avatar_url"</span>: <span class="string">"https://avatars2.githubusercontent.com/u/123456?v=3"</span>,</div><div class="line">      <span class="string">"gravatar_id"</span>: <span class="string">""</span>,</div><div class="line">      <span class="string">"url"</span>: <span class="string">"https://api.github.com/users/kjj6198"</span>,</div><div class="line">      <span class="string">"html_url"</span>: <span class="string">"https://github.com/kjj6198"</span>,</div><div class="line">      <span class="string">"followers_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/followers"</span>,</div><div class="line">      <span class="string">"following_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/following&#123;/other_user&#125;"</span>,</div><div class="line">      <span class="string">"gists_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/gists&#123;/gist_id&#125;"</span>,</div><div class="line">      <span class="string">"starred_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/starred&#123;/owner&#125;&#123;/repo&#125;"</span>,</div><div class="line">      <span class="string">"subscriptions_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/subscriptions"</span>,</div><div class="line">      <span class="string">"organizations_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/orgs"</span>,</div><div class="line">      <span class="string">"repos_url"</span>: <span class="string">"https://api.github.com/users/kalanchen/repos"</span>,</div><div class="line">      <span class="string">"events_url"</span>: <span class="string">"https://api.github.com/users/kjj6198/events&#123;/privacy&#125;"</span>,</div><div class="line">      <span class="string">"received_events_url"</span>:<span class="string">"https://api.github.com/users/kjj6198/received_events"</span>,</div><div class="line">      <span class="string">"type"</span>: <span class="string">"User"</span>,</div><div class="line">      <span class="string">"site_admin"</span>: <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"created_at"</span>: <span class="string">"2017-03-01T12:24:20Z"</span>,</div><div class="line">    <span class="string">"updated_at"</span>: <span class="string">"2017-03-01T12:24:20Z"</span>,</div><div class="line">    <span class="string">"statuses_url"</span>: <span class="string">"https://api.github.com/repos/my-github/my-repo/deployments/12345667/statuses"</span>,</div><div class="line">    <span class="string">"repository_url"</span>: <span class="string">"https://api.github.com/repos/my-github/my-repo"</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æ›´å¤š deployment API å¯ä»¥åˆ° <a href="https://developer.github.com/v3/repos/deployments/" target="_blank" rel="external">github deployment API</a> çœ‹çœ‹ã€‚</p>
</li>
</ol>
<h3 id="è¨­å®š-heaven"><a href="#è¨­å®š-heaven" class="headerlink" title="è¨­å®š heaven"></a>è¨­å®š heaven</h3><ul>
<li>åˆ° <a href="https://github.com/atmos/heaven" target="_blank" rel="external">heaven</a> å°‡ repo clone ä¸‹ä¾†ã€‚</li>
<li>è¨­å®šå…¨åŸŸè®Šæ•¸</li>
</ul>
<table>
<thead>
<tr>
<th>è®Šæ•¸åç¨±</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEPLOYMENT_PRIVATE_KEY</td>
<td>å› ç‚º heaven æ˜¯ç”¨ ssh ç™»å…¥ï¼Œéœ€è¦ private keyã€‚å¦‚æœ server åœ¨ ec2 ä¸Šï¼Œä¹Ÿå¯ä»¥ç”¨ pem çš„æ–¹å¼ä¾†è¨­å®šã€‚</td>
</tr>
<tr>
<td>GITHUB_CLIENT_ID</td>
<td>åˆ°å€‹äººè¨­å®šé é¢ &gt; OAuth application ç”¢ç”Ÿ</td>
</tr>
<tr>
<td>GITHUB_CLIENT_SECRET</td>
<td>åˆ°å€‹äººè¨­å®šé é¢ &gt; OAuth application ç”¢ç”Ÿ</td>
</tr>
<tr>
<td>DATABASE_URL</td>
<td>heaven æœƒå»ºç«‹è³‡æ–™åº«ç´€éŒ„ deployment</td>
</tr>
<tr>
<td>GITHUB_TOKEN</td>
<td>heaven æœƒä½¿ç”¨ gist ä¾†ç•¶ä½œ stdout stderrã€‚æ‰€ä»¥åœ¨è¨­å®š token æ™‚è¨˜å¾—æŠŠ <code>gist</code> æ‰“å‹¾å‹¾ã€‚</td>
</tr>
</tbody>
</table>
<p>å…¶ä»–çš„è®Šæ•¸å¯ä»¥åˆ° <a href="https://github.com/atmos/heaven/blob/master/doc/installation.md" target="_blank" rel="external">é€™è£¡</a> æŸ¥çœ‹ã€‚</p>
<p>è£œå……èªªæ˜ <code>DEPLOYMENT_PRIVATE_KEY</code>ï¼šåŸå§‹æª”æ¡ˆé•·é€™æ¨£</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">-----BEGIN RSA PRIVATE KEY-----</div><div class="line">MJVGa/WNT9aFs63ykxLCdGzav8CfQ5vKXrLrllHXUYFaB2yaN72L+fSsXAy9zMs2</div><div class="line">vy6wV2fB6j3YrVNCnBwUUNGTX9Ka6eeK98dCvHVyyE9Iz3CJAWZxaI03Px/xX9ps</div><div class="line">M4kDWe7IA6+mnuCVSzwQVWMdOoAXbQbhGdfeixbqljNhJrKW/jA9w4BNarwGYv4E</div><div class="line">0MwdU9x7zpk826ytza87yXHSdNuTKcsGQk4XHMYxJECj4EM8vTlVlEyEXZtCeh2z</div><div class="line">P4bjYkTcBom4nC/q7Ea7Pmy1iDJqs0qc1L/xtNMypMhx4iIaeDVawkvBaL6t9IPT</div><div class="line">KVuC9Y1uw5nJP1gwxXa5qoazhcikzqRYmaeWIzsZrcVShZBrJO9/a/APxXY7qJpJ</div><div class="line">0r1YYTykw7THYj2QYiv8cfF64/vh9cB0NELEp5hIuS82Mf6CjqRR7QYR+By3uIdD</div><div class="line">hQ77NMpQlmIC+TCJsLoADqwmEEZCiQSejtkXXtN/mNl581jP8+ViNkWZfPYWe7g6</div><div class="line">yUeXVN1cBPo6AIu+lStE+SlR8lbu7sdpn6lid1pJf50zeythabze81y/nrAdx+Jn</div><div class="line">scACBJBrERkhm2wdULkqwMV2g0U53YpYVAs2fFU1hGzRcE5zF1sdy9RLLX45Mzrm</div><div class="line">lRErTbSUcnoQJhhCso5uNY6MMnr/rQF920KA0Ufr40IBcQ8bOSX7lJucST5bZLDg</div><div class="line">H7g16rimHgK4I9rrvKy4plvbolfpuKGMYJDS3Q7IW5cL5lWLU3HaVSn+VyZe8p3A</div><div class="line">prVx0XmSCwpmUzbDI6FoqniVPVdgis2tV1uKdnJPVn0DoK0ersosGXmALytbYLeE</div><div class="line">arH/cIlGGCoGbIX+Iv3u8aICBEG2eR8eXmQSlGI5rp9hGK/JrlkL3PywVmPw4Efi</div><div class="line">atiS6Y12Tuu8bdpPxBTzXK3PoZ23Pc+1l7NXXIzBeGnj56bALOIbAY5kg+lIRdtP</div><div class="line">NSTAW8IVgFJUl4uzy/NXn/ewiE093ZVs59I2x4OoS14S20mkM/ldWbvlVm4Z3JxC</div><div class="line">xIWsIV8aLznttic5MJUGjGoqH1Brg0o1HyWdkoEcC1N0G57oO4pN4UTD5co5xY9j</div><div class="line">Ai2NIcFCYzqrdTfSlPWJBZLhjZ5hOXIwuTeJfRxDAVphaUqfpXb3o3URGRWiGENA</div><div class="line">kIYKiq4XeNguwrFBzg5CB7NEKvjbjJ31GI26yAPa7yrKpuNFAjPpO6JKdL8slvx8</div><div class="line">GXCOSbhGPFxzmtYzEeMxmnHqOa0Z953XeheKfJoipqRAyENxPBvclDonqVfxuTvw</div><div class="line">cZzqFD+XjDJCJ5INwuwk2WupVzQjzV6TagcIX63Kq1Z9HSoFIBiCrdLzTMDG4Ro3</div><div class="line">2wpN1tFQFz6alvwKtifGwhvG3qqmsfcQqw56gGY0DWIqG5x/thdG7UzZT7iMVDJV</div><div class="line">LAO5wNnBK6L+feov9LqP7ONAonBVawmTv0ArjVhhkYZEi6d+ymvPpL1ORFAymLne</div><div class="line">dpk4VmmmQvkUu0KudRqulavTIrnXFkuv2va+5X9mHGoNNMo1TXk2XX1eM4Rc7nAY</div><div class="line">6IwPyAuFEtT5ocWBklB/qUZtdu4fG876o0X87GklR9ZfPG+tWpH2F+1j1mMHKuiP</div><div class="line">-----END RSA PRIVATE KEY-----</div></pre></td></tr></table></figure>
<p>è¦ä¿®æ”¹æˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-----BEGIN RSA PRIVATE KEY-----\nMJVGa/WNT9aFs63ykxLCdGzav8CfQ5vKXrLrllHXUYFaB2yaN72L+fSsXAy9zMs2\nvy6wV2fB6j3YrVNCnBwUUNGTX9Ka6eeK98dCvHVyyE9Iz3CJAWZxaI03Px/xX9ps\nM4kDWe7IA6+mnuCVSzwQVWMdOoAXbQbhGdfeixbqljNhJrKW/jA9w4BNarwGYv4E\n0MwdU9x7zpk826ytza87yXHSdNuTKcsGQk4XHMYxJECj4EM8vTlVlEyEXZtCeh2z\nP4bjYkTcBom4nC/q7Ea7Pmy1iDJqs0qc1L/xtNMypMhx4iIaeDVawkvBaL6t9IPT\nKVuC9Y1uw5nJP1gwxXa5qoazhcikzqRYmaeWIzsZrcVShZBrJO9/a/APxXY7qJpJ\n0r1YYTykw7THYj2QYiv8cfF64/vh9cB0NELEp5hIuS82Mf6CjqRR7QYR+By3uIdD\nhQ77NMpQlmIC+TCJsLohtJEmEEZCiQSejtkXXtN/mNl581jP8+ViNkWZfPYWe7g6\nyUeXVN1cBPo6AIu+lStE+SlR8lbu7sdpn6lid1pJf50zeythabze81y/nrAdx+Jn\nscACBJBrERkhm2wdULkqwMV2g0U53YpYVAs2fFU1hGzRcE5zF1sdy9RLLX45Mzrm\nlRErTbSUcnoQJhhCso5uNY6MMnr/rQF920KA0Ufr40IBcQ8bOSX7lJucST5bZLDg\nH7g16rimHgK4I9rrvKy4plvbolfpuKGMYJDS3Q7IW5cL5lWLU3HaVSn+VyZe8p3A\nprVx0XmSCwpmUzbDI6FoqniVPVdgis2tV1uKdnJPVn0DoK0ersosGXmALytbYLeE\narH/cIlGGCoGbIX+Iv3u8aICBEG2eR8eXmQSlGI5rp9hGK/JrlkL3PywVmPw4Efi\natiS6Y12Tuu8bdpPxBTzXK3PoZ23Pc+1l7NXXIzBeGnj56bALOIbAY5kg+lIRdtP\nNSTAW8IVgFJUl4uzy/NXn/ewiE093ZVs59I2x4OoS14S20mkM/ldWbvlVm4Z3JxC\nxIWsIV8aLznttic5MJUGjGoqH1Brg0o1HyWdkoEcC1N0G57oO4pN4UTD5co5xY9j\nAi2NIcFCYzqrdTfSlPWJBZLhjZ5hOXIwuTeJfRxDAVphaUqfpXb3o3URGRWiGENA\nkIYKiq4XeNguwrFBzg5CB7NEKvjbjJ31GI26yAPa7yrKpuNFAjPpO6JKdL8slvx8\nGXCOSbhGPFxzmtYzEeMxmnHqOa0Z953XeheKfJoipqRAyENxPBvclDonqVfxuTvw\ncZzqFD+XjDJCJ5INwuwk2WupVzQjzV6TagcIX63Kq1Z9HSoFIBiCrdLzTMDG4Ro3\n2wpN1tFQFz6alvwKtifGwhvG3qqmsfcQqw56gGY0DWIqG5x/thdG7UzZT7iMVDJV\nLAO5wNnBK6L+feov9LqP7ONAonBVawmTv0ArjVhhkYZEi6d+ymvPpL1ORFAymLne\ndpk4VmmmQvkUu0KudRqulavTIrnXFkuv2va+5X9mHGoNNMo1TXk2XX1eM4Rc7nAY\n6IwPyAuFEtT5ocWBklB/qUZtdu4fG876o0X87GklR9ZfPG+tWpH2F+1j1mMHKuiP\n-----END RSA PRIVATE KEY-----</div></pre></td></tr></table></figure>
<p><em>æ—¢ç„¶å…¬é–‹ï¼Œé€™çµ„ private key ç•¶ç„¶å ±å»¢äº†</em></p>
<h4 id="è¨­å®š-Gemfile"><a href="#è¨­å®š-Gemfile" class="headerlink" title="è¨­å®š Gemfile"></a>è¨­å®š Gemfile</h4><p>å› ç‚º heaven çš„å‹•ä½œæœƒæ˜¯æ‹‰ä¸‹æœ€æ–°çš„ repo å¾Œï¼ŒåŸ·è¡Œ <code>cap ... deploy</code> çš„æŒ‡ä»¤ï¼Œæ‰€ä»¥capistrano çš„ç‰ˆæœ¬å¿…é ˆè·Ÿè¦éƒ¨ç½²çš„é‚£å€‹ç‰ˆæœ¬ç›¸åŒã€‚åŒæ™‚ï¼Œä¹Ÿè¦æ³¨æ„ä»»ä½• asset ç›¸é—œçš„ gem ä¹Ÿè¦ä¸€ä½µæ”¾å…¥ heavenã€‚èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœæˆ‘çš„ Capfile æœ‰ç”¨åˆ°</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gem <span class="string">'capistrano'</span>, <span class="string">'3.4.0'</span></div><div class="line">gem <span class="string">'capistrano3-unicorn'</span></div><div class="line">gem <span class="string">'capistrano-rails'</span></div><div class="line">gem <span class="string">'sitemap_generator'</span></div><div class="line">gem <span class="string">'capistrano-rvm'</span></div></pre></td></tr></table></figure>
<p>é‚£éº¼<strong>å°±è¦å°‡é€™äº› gem åŠ å…¥ heaven çš„ Gemfile ç•¶ä¸­</strong>ã€‚å› ç‚º heaven æœƒå°‡è¦éƒ¨ç½²çš„ repo æŠ“ä¸‹ä¾†ä¹‹å¾Œï¼Œé€²å»è³‡æ–™å¤¾è¼¸å…¥ <code>cap staging ... deploy</code> çš„æŒ‡ä»¤ï¼Œæ‰€ä»¥å¦‚æœæ²’æœ‰å®‰è£ç›¸å°æ‡‰çš„ gemï¼Œheaven å°±æ²’è¾¦æ³•éƒ¨ç½²äº†ã€‚</p>
<h3 id="ä¸²æ¥-github-deployment"><a href="#ä¸²æ¥-github-deployment" class="headerlink" title="ä¸²æ¥ github deployment"></a>ä¸²æ¥ github deployment</h3><ul>
<li>å…ˆåˆ° repo çš„ settings &gt; deploy key åŠ å…¥ ssh-keyã€‚</li>
<li>åˆ° repo çš„ settings &gt; webhooks &gt; add webhook</li>
<li>Payload URL å¡«å…¥ä½ çš„ heaven éƒ¨ç½² host çš„ç¶²å€ï¼Œä¾‹å¦‚ï¼š<a href="https://yourapp.com.tw/eventsã€‚å¦‚æœæƒ³è¦ä¿®æ”¹ï¼Œå¯ä»¥åˆ°" target="_blank" rel="external">https://yourapp.com.tw/eventsã€‚å¦‚æœæƒ³è¦ä¿®æ”¹ï¼Œå¯ä»¥åˆ°</a> heaven repo çš„ <code>routes.rb</code> ä¸­ä¿®æ”¹</li>
<li>Content Type é¸æ“‡ <code>application/json</code></li>
<li>Secret ä¾éœ€æ±‚é¸å¡«</li>
<li>ä¸‹é¢å•ä½ é€™å€‹ webhook è¦ç›£è½å“ªäº›äº‹ä»¶ï¼Œæˆ‘å€‘æ˜¯ç”¨ deployment ä¾†åšéƒ¨ç½²çš„ï¼Œæ‰€ä»¥é¸æ“‡ deployment ä»¥åŠ deployment statusã€‚</li>
</ul>
<h4 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h4><p>å¦‚æœæ˜¯éƒ¨ç½²åˆ° heroku çš„è©±ï¼Œå› ç‚º heaven è¦é–‹ redis è·Ÿ resqueã€‚è¨˜å¾—åŠ å…¥ç›¸å°æ‡‰çš„ add-on ä»¥åŠ <code>REDIS_URL</code> ã€‚</p>
<p>åŒæ™‚åˆ¥å¿˜è¨˜äº†è¦å»ºç«‹è³‡æ–™åº« <code>heroku run rake db:migrate</code>ã€‚</p>
<h2 id="hubot-deploy-å¸¸ç”¨æŒ‡ä»¤"><a href="#hubot-deploy-å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="hubot-deploy å¸¸ç”¨æŒ‡ä»¤"></a>hubot-deploy å¸¸ç”¨æŒ‡ä»¤</h2><ul>
<li><code>hubot deploy:version</code> ç›®å‰ç‰ˆæœ¬</li>
<li><code>hubot deploy repo</code>ï¼š æ ¹æ“š <code>apps.json</code> deploy æŒ‡å®šçš„ repo nameã€‚</li>
<li><code>hubot deploy repo/branch</code>ï¼šå°‡æŒ‡å®š repo çš„æŸä¸€å€‹ branch éƒ¨ç½²åˆ°é è¨­çš„ environment ä¸­ã€‚å¯è¨­å®š <code>HUBOT_DEPLOY_DEFAULT_ENVIRONMENT</code> ä¾†æ±ºå®š</li>
<li><code>hubot deploy repo/branch to staging</code>ï¼šå°‡æŒ‡å®š repo ä¸­çš„ branch éƒ¨ç½²åˆ° <code>staging</code></li>
</ul>
<h2 id="ç­†è¨˜"><a href="#ç­†è¨˜" class="headerlink" title="ç­†è¨˜"></a>ç­†è¨˜</h2><ul>
<li><p>heaven çš„æ–‡ä»¶é›–ç„¶ä¸æ˜æ‰€ä»¥ï¼Œä½†æ˜¯ç¨‹å¼ç¢¼è·Ÿæ¸¬è©¦å¯«å¾—è »å®Œæ•´çš„ï¼Œç†Ÿæ‚‰ ruby çš„é–‹ç™¼è€…ç”šè‡³å¯ä»¥å°‡æ•´å€‹ heaven æ¶è¨­å¥½ï¼Œä¿®æ”¹ä¸€ä¸‹ç¨‹å¼ç¢¼ï¼ŒåŠ ä¸Š routesï¼Œç›´æ¥å»ºç«‹ UI ä¸€éµéƒ¨ç½²ã€‚</p>
</li>
<li><p><code>OptionParser::AmbiguousOption: ambiguous option: -s</code>ï¼šä¸ç¢ºå®šæ˜¯ä¸æ˜¯ Capistrano æ›´æ–°ä¹‹å¾ŒæŒ‡ä»¤æœ‰è®Šå‹•ã€‚è§£æ±ºæ–¹æ³•æ˜¯åˆ° <code>lib/heaven/provider/capistrano.rb</code> ä¿®æ”¹ <code>deploy_command</code></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Heaven</span></span></div><div class="line">  <span class="comment"># Top-level module for providers.</span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Provider</span></span></div><div class="line">    <span class="comment"># The capistrano provider.</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Capistrano</span> &lt; DefaultProvider</span></div><div class="line"> 	.....</div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span></div><div class="line">        <span class="keyword">return</span> execute_and_log([<span class="string">"/usr/bin/true"</span>]) <span class="keyword">if</span> Rails.env.test?</div><div class="line"></div><div class="line">        unless File.exist?(checkout_directory)</div><div class="line">          log <span class="string">"Cloning <span class="subst">#&#123;repository_url&#125;</span> into <span class="subst">#&#123;checkout_directory&#125;</span>"</span></div><div class="line">          execute_and_log([<span class="string">"git"</span>, <span class="string">"clone"</span>, clone_url, checkout_directory])</div><div class="line">        <span class="keyword">end</span></div><div class="line"></div><div class="line">        Dir.chdir(checkout_directory) <span class="keyword">do</span></div><div class="line">          log <span class="string">"Fetching the latest code"</span></div><div class="line">          execute_and_log(<span class="string">%w&#123;git fetch&#125;</span>)</div><div class="line">          execute_and_log([<span class="string">"git"</span>, <span class="string">"reset"</span>, <span class="string">"--hard"</span>, sha])</div><div class="line">          deploy_command = [cap_path, environment, <span class="string">"éƒ¨ç½²çš„ cap æŒ‡ä»¤"</span>]</div><div class="line">          log <span class="string">"Executing capistrano: <span class="subst">#&#123;deploy_command.join(<span class="string">" "</span>)&#125;</span>"</span></div><div class="line">          execute_and_log(deploy_command)</div><div class="line">        <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
</li>
<li><p>å› ç‚º heaven åœ¨éƒ¨ç½²æ™‚æœƒä½¿ç”¨ gist ç•¶ä½œ stdout è·Ÿ stderrï¼Œåœ¨è¨­å®š GITHUB_TOKEN çš„æ™‚å€™ä¸€å®šè¦è¨˜å¾—æŠŠ gist çš„ scope æ‰“å‹¾</p>
</li>
<li><p><code>Net::SSH::AuthenticationFailed: Authentication failed for user apps@staging.tripmoment.com</code> ï¼šSSH private_key è¨­å®šæœ‰èª¤ã€‚å…ˆç¢ºå®šé€™çµ„ ssh key æ˜¯å¦å·²ç¶“åŠ å…¥ githubï¼Œå†ä¾†ç¢ºå®šå°‡ <code>passphrase</code> æ‹¿æ‰ï¼Œä¸¦ä¸”å°‡ ssh private key è®Šæˆä¸€è¡ŒåŠ ä¸Š \nã€‚</p>
</li>
<li><p><code>ArgumentError: Could not parse PKey: no start line</code> æ²’æœ‰å°‡ SSH private key çš„ passphrase ç§»é™¤</p>
</li>
</ul>
<h2 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h2><p>é€šå¸¸åœ¨å…¬å¸è£¡é ­ï¼Œé–‹ç™¼åœ˜éšŠäººæ•¸ä¸å¤šçš„è©±ï¼Œdevops éƒ½æ˜¯ç”±å¾Œç«¯å…¼ä»»çš„ï¼Œå‰ç«¯æ¯”è¼ƒå°‘æ¥è§¸ã€‚ä¸éç”¨ã€Œæˆ‘æ˜¯å‰ç«¯ï¼Œæˆ‘ä¸éœ€è¦ç®¡ devopsã€é€™ç¨®è—‰å£æªå¡è‡ªå·±ä¸å»å­¸ç¿’å¥½åƒä¹Ÿèªªä¸å¤ªéå»ï¼Œç•¢ç«Ÿé–‹ç™¼ä¸€å€‹å¥å…¨çš„ç³»çµ±çµ•å°ä¸å¯èƒ½åªæœ‰å‰ç«¯è€Œå·²ã€‚</p>
<p>é€™ç¯‡æ–‡ç« è©¦è‘—å°‡æ–‡ä»¶ä¸­æ²’æœ‰æåˆ°æˆ–æ˜¯çœç•¥çš„æ­¥é©Ÿæ•´åˆèµ·ä¾†ï¼Œheaven è·Ÿ hubot-deploy çš„æ–‡ä»¶ä¸­æœ‰å¤ªå¤šæ²’æœ‰æåˆ°çš„ç´°ç¯€ï¼Œå°è‡´æ•´åˆèµ·ä¾†æ™‚éœ€è¦èŠ±ä¸å°‘æ™‚é–“è©¦éŒ¯ã€‚å¸Œæœ›èƒ½å¤ ç¯€çœå¤§å®¶è¸©é›·è·Ÿç¿»åŸå§‹ç¢¼çš„æ™‚é–“ã€‚</p>
<p>é€™ç¯‡æ–‡ç« é‚„æœ‰è¨±å¤š devops çš„ç´°ç¯€æ²’æœ‰è©³è¿°ï¼Œç•¢ç«Ÿå»ºç«‹ä¸€å¥—å®Œæ•´çš„ devops pipeline éœ€è¦æ™‚é–“ï¼Œè‡ªå·±å°æ–¼ CI/CD çš„è¨­å®šä¹Ÿé‚„ä¸å¤ ç†Ÿæ‚‰ã€‚</p>
<h3 id="åƒè€ƒè³‡æºï¼š"><a href="#åƒè€ƒè³‡æºï¼š" class="headerlink" title="åƒè€ƒè³‡æºï¼š"></a>åƒè€ƒè³‡æºï¼š</h3><ul>
<li><a href="https://github.com/ocowchun/many101/blob/master/devops/chatops.md" target="_blank" rel="external">é¡†é¡† devops ç­†è¨˜</a></li>
<li><a href="http://lazier.cwchang.me/2015/01/24/ChatOps-Hubot-Capistrano-Heaven/" target="_blank" rel="external">chatops</a></li>
</ul>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://kjj6198.github.io/blog/blog/2017/03/01/chatops/" data-id="cj2stn55e0001og5taxj1l8by" class="article-share-link"><i class="fa fa-share"></i>åˆ†äº«åˆ°</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>é—œæ³¨æˆ‘ :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="https://twitter.com/kalanyei" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/kjj6198" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/blog/2017/02/28/webgl-it/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
        <p class="article-nav-title">IT éµäººå¹«å®Œè³½å¿ƒå¾—</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">æœ€æ–°æ–‡ç« </h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/blog/categories/rails/">rails</a></p>
                            <p class="item-title"><a href="/blog/2017/03/01/chatops/" class="title">Rails app è‡ªå‹•åŒ–éƒ¨å±¬ - hubot èˆ‡ heaven</a></p>
                            <p class="item-date"><time datetime="2017-03-01T15:12:42.000Z" itemprop="datePublished">2017-03-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/blog/categories/å‰ç«¯/">å‰ç«¯</a></p>
                            <p class="item-title"><a href="/blog/2017/02/28/webgl-it/" class="title">IT éµäººå¹«å®Œè³½å¿ƒå¾—</a></p>
                            <p class="item-date"><time datetime="2017-02-28T15:44:42.000Z" itemprop="datePublished">2017-02-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/blog/categories/è®€æ›¸å¿ƒå¾—/">è®€æ›¸å¿ƒå¾—</a></p>
                            <p class="item-title"><a href="/blog/2017/02/22/morden-time/" class="title">ä¼Šå‚å¹¸å¤ªéƒ - æ‘©ç™»æ™‚ä»£</a></p>
                            <p class="item-date"><time datetime="2017-02-21T16:00:00.000Z" itemprop="datePublished">2017-02-22</time></p>
                        </div>
                    </li>
                
                    <li>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/blog/categories/å‰ç«¯/">å‰ç«¯</a></p>
                            <p class="item-title"><a href="/blog/2017/02/01/responsive-flex/" class="title">é«˜åº¦ç›¸åŒçš„æ’ç‰ˆè§£æ±ºæ–¹æ¡ˆ</a></p>
                            <p class="item-date"><time datetime="2017-02-01T07:33:41.000Z" itemprop="datePublished">2017-02-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/blog/categories/å‰ç«¯/">å‰ç«¯</a></p>
                            <p class="item-title"><a href="/blog/2017/01/01/code-review-101/" class="title">code-review-101</a></p>
                            <p class="item-date"><time datetime="2016-12-31T16:00:00.000Z" itemprop="datePublished">2017-01-01</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">åˆ†é¡</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/rails/">rails</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/å‰ç«¯/">å‰ç«¯</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/å‰ç«¯é€±åˆŠ/">å‰ç«¯é€±åˆŠ</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/ç¨‹å¼ç­†è¨˜/">ç¨‹å¼ç­†è¨˜</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/è®€æ›¸å¿ƒå¾—/">è®€æ›¸å¿ƒå¾—</a><span class="category-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">æ­¸æª”</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/03/">ä¸‰æœˆ 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/02/">äºŒæœˆ 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/01/">ä¸€æœˆ 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/11/">åä¸€æœˆ 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/10/">åæœˆ 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/09/">ä¹æœˆ 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/07/">ä¸ƒæœˆ 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/06/">å…­æœˆ 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/05/">äº”æœˆ 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/03/">ä¸‰æœˆ 2016</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit" style="text-align: center;">
                <p>&copy; 2017 Kalan</p>
            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'frontendclothesline';
    
    
    var disqus_url = 'http://kjj6198.github.io/blog/blog/2017/03/01/chatops/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/blog/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/blog/libs/lightgallery/js/lg-video.min.js"></script>
    


<!-- Custom Scripts -->
<script src="/blog/js/main.js"></script>

    </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
